<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ShadowMap</title>
  <style>
    :root { --bg:#f5f5f5; --fg:#333; --accent:#0077ff; }
    body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--fg); display:flex; justify-content:center; }
    .card { background:#fff; max-width:600px; width:100%; padding:2rem; margin-top:3rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:1rem; }
    input { width:100%; padding:0.5rem; margin-top:0.25rem; box-sizing:border-box; }
    button { margin-top:1rem; width:100%; padding:0.75rem; background:var(--accent); color:#fff; border:none; cursor:pointer; }
    button:disabled { background:#888; cursor:default; }
    .status { margin-top:1rem; }
    pre { background:#eee; padding:1rem; border-radius:4px; overflow:auto; max-height:300px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ShadowMap</h1>
    <label>Token
      <input id="token" type="text" value="testtoken" />
    </label>
    <label>Domain
      <input id="domain" type="text" placeholder="example.com" />
    </label>
    <button id="start">Start Scan</button>
    <p class="status">Job: <span id="job"></span> â€“ Status: <span id="status">idle</span></p>
    <pre id="report" class="hidden"></pre>
  </div>
  <script>
    const API_URL = 'http://localhost:8080';
    const tokenInput = document.getElementById('token');
    const domainInput = document.getElementById('domain');
    const startBtn = document.getElementById('start');
    const statusEl = document.getElementById('status');
    const jobEl = document.getElementById('job');
    const reportEl = document.getElementById('report');

    startBtn.addEventListener('click', async () => {
      const token = tokenInput.value.trim();
      const domain = domainInput.value.trim();
      if (!domain) return;
      startBtn.disabled = true;
      statusEl.textContent = 'queued';
      jobEl.textContent = '';
      reportEl.classList.add('hidden');
      const res = await fetch(API_URL + '/jobs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token,
        },
        body: JSON.stringify({ domain }),
      });
      const { id } = await res.json();
      jobEl.textContent = id;
      poll(id, token);
    });

    function poll(id, token) {
      const timer = setInterval(async () => {
        const res = await fetch(API_URL + '/jobs/' + id, {
          headers: { 'Authorization': 'Bearer ' + token },
        });
        const data = await res.json();
        statusEl.textContent = data.status;
        if (data.status === 'completed' || data.status === 'failed') {
          clearInterval(timer);
          startBtn.disabled = false;
          if (data.status === 'completed') {
            const rep = await fetch(API_URL + '/jobs/' + id + '/report', {
              headers: { 'Authorization': 'Bearer ' + token },
            });
            reportEl.textContent = await rep.text();
            reportEl.classList.remove('hidden');
          }
        }
      }, 2000);
    }
  </script>
</body>
</html>
